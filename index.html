<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فرم بازدید سرگروه‌های آموزشی از کلاس‌های درس مدارس ابتدایی - نسخه مدرن</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        @font-face { font-family: 'Vazir'; src: url('https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.ttf'); }
        * { font-family: 'Vazir', sans-serif !important; font-size: 12pt; }
        body { background: linear-gradient(135deg, #e6f2ff, #ffffff); padding: 20px; min-height: 100vh; }
        .card { border-radius: 25px; box-shadow: 0 12px 30px rgba(0,0,0,0.15); overflow: hidden; background: white; }
        .header { background: linear-gradient(45deg, #007bff, #00bfff); color: white; padding: 25px; text-align: center; font-size: 1.6rem; font-weight: bold; border-bottom: 5px solid #0056b3; }
        .form-control { border-radius: 10px; border: 1px solid #ced4da; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        .table th { background: #e7f3ff; color: #0056b3; font-weight: bold; }
        .score { width: 20px; height: 20px; margin: 0 10px; cursor: pointer; }
        .signature-pad { border: 2px dashed #007bff; border-radius: 15px; background: #f8fbff; box-shadow: 0 4px 10px rgba(0,123,255,0.1); }
        .radar-container { max-width: 450px; margin: 30px auto; padding: 20px; background: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,123,255,0.15); }
        .saved-row { background: #e8f4fd !important; }
        .btn { border-radius: 50px; padding: 10px 30px; font-weight: bold; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        @media print {
            body { background: white !important; padding: 0 !important; }
            .no-print, .btn, .radar-container { display: none !important; }
            .card { box-shadow: none; border: none; margin: 0; }
            .container { max-width: 100% !important; padding: 0; }
            td, th, label, input, textarea { font-size: 9pt !important; padding: 4px !important; }
            .table { border-collapse: collapse; margin-bottom: 10px; page-break-inside: avoid; }
            .row { page-break-inside: avoid; }
            @page { margin: 5mm; size: A4; }
            .signature-pad { border: 1px solid #000; height: 80px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <div class="header"><i class="fas fa-chalkboard-teacher me-2"></i> فرم بازدید سرگروه‌های آموزشی از کلاس‌های درس مدارس ابتدایی</div>
        <div class="card-body p-4">

            <!-- مشخصات کلی -->
            <div class="row g-3 mb-4">
                <div class="col-md-3"><input type="text" class="form-control" placeholder="منطقه" id="region"></div>
                <div class="col-md-4"><input type="text" class="form-control" placeholder="نام مدرسه" id="school"></div>
                <div class="col-md-3">
                    <input type="date" class="form-control" id="date">
                    <small id="jalali_date" class="form-text text-muted"></small>
                </div>
                <div class="col-md-2"><input type="time" class="form-control" placeholder="ساعت شروع" id="time_start"></div>
                <div class="col-md-2"><input type="time" class="form-control" placeholder="ساعت پایان" id="time_end"></div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label>جنسیت:</label>
                    <div class="form-check form-check-inline"><input type="radio" class="form-check-input" name="gender" value="دخترانه" id="gender_girl"><label for="gender_girl">دخترانه</label></div>
                    <div class="form-check form-check-inline"><input type="radio" class="form-check-input" name="gender" value="پسرانه" id="gender_boy"><label for="gender_boy">پسرانه</label></div>
                    <div class="form-check form-check-inline"><input type="radio" class="form-check-input" name="gender" value="مختلط" id="gender_mixed"><label for="gender_mixed">مختلط</label></div>
                </div>
                <div class="col-md-8">
                    <label>نوع مدرسه:</label>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input" id="type_shahid"><label for="type_shahid">شاهد</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input" id="type_heyat"><label for="type_heyat">هیئت امنایی</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input" id="type_gheyr"><label for="type_gheyr">غیردولتی</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input" id="type_dolati_sh"><label for="type_dolati_sh">دولتی شهری</label></div>
                    <div class="form-check form-check-inline"><input type="checkbox" class="form-check-input" id="type_dolati_r"><label for="type_dolati_r">دولتی روستایی</label></div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-4"><input type="text" class="form-control" placeholder="پایه/پایه‌های تدریس" id="grade"></div>
                <div class="col-md-4"><input type="number" class="form-control" placeholder="تعداد دانش‌آموزان (نفر)" id="students"></div>
                <div class="col-md-4"><input type="number" class="form-control" placeholder="تعداد دانش‌آموزان با نیازهای ویژه (نفر)" id="special_students"></div>
            </div>

            <!-- مشخصات آموزگار -->
            <h5 class="text-primary mb-3"><i class="fas fa-user-tie me-2"></i> مشخصات آموزگار</h5>
            <div class="row g-3 mb-4">
                <div class="col-md-4"><input type="text" class="form-control" placeholder="نام و نام خانوادگی" id="teacher_name"></div>
                <div class="col-md-3"><input type="text" class="form-control" placeholder="وضعیت استخدامی" id="employment_status"></div>
                <div class="col-md-2"><input type="text" class="form-control" placeholder="کد پرسنلی" id="personnel_code"></div>
                <div class="col-md-3"><input type="text" class="form-control" placeholder="مدرک تحصیلی" id="degree"></div>
                <div class="col-md-4"><input type="text" class="form-control" placeholder="رشته تحصیلی" id="major"></div>
                <div class="col-md-4"><input type="number" class="form-control" placeholder="سابقه تدریس (سال)" id="teaching_exp"></div>
                <div class="col-md-4"><input type="number" class="form-control" placeholder="سابقه تدریس در پایه فعلی (سال)" id="current_grade_exp"></div>
            </div>

            <!-- جدول ارزیابی فعالیت‌های آموزشی -->
            <h5 class="text-primary mb-3"><i class="fas fa-clipboard-check me-2"></i> معیارهای ارزیابی گزارش بازدید از فعالیت‌های آموزشی در کلاس درس</h5>
            <table class="table table-bordered text-center">
                <thead class="table-primary">
                    <tr><th>محورها</th><th>شاخص‌های بازدید</th><th>مطلوب</th><th>خوب</th><th>قابل بهبود</th></tr>
                </thead>
                <tbody>
                    <tr><td rowspan="3">الف) فعالیت‌های مقدماتی تدریس (بررسی دفتر کلاسی آموزگار)</td><td>تدوین مناسب برنامه هفتگی در دفتر مدیریت فرآیند یاددهی-یادگیری - نصب برنامه هفتگی در کلاس</td><td><input type="radio" name="a1" value="3" class="score"></td><td><input type="radio" name="a1" value="2" class="score"></td><td><input type="radio" name="a1" value="1" class="score"></td></tr>
                    <tr><td>درج مشخصات کامل دانش‌آموزان در دفتر مدیریت فرآیند یاددهی-یادگیری، ثبت خلاصه فعالیت‌ها و سطوح عملکرد و ...</td><td><input type="radio" name="a2" value="3" class="score"></td><td><input type="radio" name="a2" value="2" class="score"></td><td><input type="radio" name="a2" value="1" class="score"></td></tr>
                    <tr><td>ثبت و رعایت بودجه‌بندی با در نظر گرفتن شرایط دانش‌آموزان</td><td><input type="radio" name="a3" value="3" class="score"></td><td><input type="radio" name="a3" value="2" class="score"></td><td><input type="radio" name="a3" value="1" class="score"></td></tr>
                    <tr><td rowspan="3">ب) تلاش معلم در جهت خودارتقایی</td><td>حضور در جلسات ضمن خدمت و دوره‌های آموزشی</td><td><input type="radio" name="b1" value="3" class="score"></td><td><input type="radio" name="b1" value="2" class="score"></td><td><input type="radio" name="b1" value="1" class="score"></td></tr>
                    <tr><td>بهره‌برداری از مجلات کمک آموزشی (رشد، پیوند، تربیت و ...)</td><td><input type="radio" name="b2" value="3" class="score"></td><td><input type="radio" name="b2" value="2" class="score"></td><td><input type="radio" name="b2" value="1" class="score"></td></tr>
                    <tr><td>میزان آگاهی معلم از آخرین تحولات آموزشی در کتب درسی و شیوه‌های تدریس</td><td><input type="radio" name="b3" value="3" class="score"></td><td><input type="radio" name="b3" value="2" class="score"></td><td><input type="radio" name="b3" value="1" class="score"></td></tr>
                    <tr><td rowspan="2">پ) مدیریت کلاس</td><td>مدیریت زمان فعالیت یاددهی-یادگیری طبق برنامه کلاسی (اختصاص زمان مناسب برای تدریس دروس مختلف)</td><td><input type="radio" name="p1" value="3" class="score"></td><td><input type="radio" name="p1" value="2" class="score"></td><td><input type="radio" name="p1" value="1" class="score"></td></tr>
                    <tr><td>کلاس‌داری مناسب و توجه به همه دانش‌آموزان براساس توانایی‌ها و شکوفایی استعدادهای آنان</td><td><input type="radio" name="p2" value="3" class="score"></td><td><input type="radio" name="p2" value="2" class="score"></td><td><input type="radio" name="p2" value="1" class="score"></td></tr>
                    <tr><td rowspan="3">ت) کاربرد تجهیزات و رسانه‌های آموزشی</td><td>استفاده از فضا، امکانات و منابع آموزشگاهی از جمله (کارگاه، کتابخانه، آزمایشگاه و سایر امکانات مدرسه)</td><td><input type="radio" name="t1" value="3" class="score"></td><td><input type="radio" name="t1" value="2" class="score"></td><td><input type="radio" name="t1" value="1" class="score"></td></tr>
                    <tr><td>بهره‌گیری از وسایل آموزشی و دست‌سازهای موجود در مدرسه</td><td><input type="radio" name="t2" value="3" class="score"></td><td><input type="radio" name="t2" value="2" class="score"></td><td><input type="radio" name="t2" value="1" class="score"></td></tr>
                    <tr><td>ابتکارات در زمینه تهیه وسایل و ابزارهای آموزشی</td><td><input type="radio" name="t3" value="3" class="score"></td><td><input type="radio" name="t3" value="2" class="score"></td><td><input type="radio" name="t3" value="1" class="score"></td></tr>
                    <tr><td rowspan="5">ث) صلاحیت‌های حرفه‌ای معلم</td><td>فراهم ساختن فرصت تفکر به دانش‌آموزان برای نتیجه‌گیری و ساخت دانش خویش (با تاکید بر الگوی ساختن‌گرا)</td><td><input type="radio" name="th1" value="3" class="score"></td><td><input type="radio" name="th1" value="2" class="score"></td><td><input type="radio" name="th1" value="1" class="score"></td></tr>
                    <tr><td>جلب مشارکت دانش‌آموزان در فرآیند تدریس و تاکید بر مسئله‌محوری</td><td><input type="radio" name="th2" value="3" class="score"></td><td><input type="radio" name="th2" value="2" class="score"></td><td><input type="radio" name="th2" value="1" class="score"></td></tr>
                    <tr><td>تسلط معلم بر محتوای کتاب‌های درسی و صحت محتوای ارائه شده توسط ایشان</td><td><input type="radio" name="th3" value="3" class="score"></td><td><input type="radio" name="th3" value="2" class="score"></td><td><input type="radio" name="th3" value="1" class="score"></td></tr>
                    <tr><td>تسلط معلم بر روش‌های فعال و نوین تدریس</td><td><input type="radio" name="th4" value="3" class="score"></td><td><input type="radio" name="th4" value="2" class="score"></td><td><input type="radio" name="th4" value="1" class="score"></td></tr>
                    <tr><td>تسلط کامل بر رویکردهای آموزشی دروس (زبان‌آموزی در فارسی، حل مسئله در ریاضی، مشاهده، آزمایش و گزارش‌نویسی در علوم، درونی شدن اهداف در درس هدیه‌های آسمان)</td><td><input type="radio" name="th5" value="3" class="score"></td><td><input type="radio" name="th5" value="2" class="score"></td><td><input type="radio" name="th5" value="1" class="score"></td></tr>
                    <tr><td rowspan="1">ج) بررسی تکالیف و فعالیت‌ها</td><td>بررسی دقیق و ارائه بازخورد به موقع، سازنده و مناسب به فعالیت‌ها و تمرین‌ها و سایر تکالیف کلاسی (با تاکید بر بازخورد توصیفی)</td><td><input type="radio" name="j1" value="3" class="score"></td><td><input type="radio" name="j1" value="2" class="score"></td><td><input type="radio" name="j1" value="1" class="score"></td></tr>
                    <tr><td rowspan="2">چ) ارزشیابی</td><td>استفاده از ابزارهای سنجش مشاهده‌ای (چک لیست، پوشه کار، واقعه‌نگاری، ثبت در دفتر مدیریت کلاس، آزمون عملکردی، تکالیف مهارت‌محور و ...)</td><td><input type="radio" name="ch1" value="3" class="score"></td><td><input type="radio" name="ch1" value="2" class="score"></td><td><input type="radio" name="ch1" value="1" class="score"></td></tr>
                    <tr><td>استفاده از شیوه‌های متنوع در ارائه بازخورد با تاکید بر بازخورد توصیفی (دیداری- نمایشی، شفاهی، کتبی)</td><td><input type="radio" name="ch2" value="3" class="score"></td><td><input type="radio" name="ch2" value="2" class="score"></td><td><input type="radio" name="ch2" value="1" class="score"></td></tr>
                </tbody>
            </table>

            <!-- فعالیت‌های ابتکاری و غیره -->
            <div class="row g-3 mb-4">
                <div class="col-12"><textarea class="form-control" rows="3" placeholder="فعالیت‌های ابتکاری و خلاقانه" id="creative_activities"></textarea></div>
                <div class="col-12"><textarea class="form-control" rows="3" placeholder="ارزیابی نهایی" id="final_evaluation"></textarea></div>
                <div class="col-12"><textarea class="form-control" rows="3" placeholder="موارد قابل پیگیری" id="follow_up"></textarea></div>
            </div>

            <!-- نمودار عنکبوتی -->
            <div class="radar-container no-print">
                <canvas id="radarChart"></canvas>
            </div>

            <!-- گزارش توصیفی بازدید -->
            <h5 class="text-primary mb-3"><i class="fas fa-file-alt me-2"></i> گزارش بازدید از فعالیت‌های آموزشی در کلاس درس</h5>
            <div class="accordion" id="descriptiveReport">
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#axisA">محور الف</button></h2>
                    <div id="axisA" class="accordion-collapse collapse"><div class="accordion-body">
                        <textarea class="form-control mb-2" rows="3" placeholder="نقاط قوت" id="strength_a"></textarea>
                        <textarea class="form-control" rows="3" placeholder="نقاط ضعف" id="weakness_a"></textarea>
                    </div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#axisB">محور ب</button></h2>
                    <div id="axisB" class="accordion-collapse collapse"><div class="accordion-body">
                        <textarea class="form-control mb-2" rows="3" placeholder="نقاط قوت" id="strength_b"></textarea>
                        <textarea class="form-control" rows="3" placeholder="نقاط ضعف" id="weakness_b"></textarea>
                    </div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#axisP">محور پ</button></h2>
                    <div id="axisP" class="accordion-collapse collapse"><div class="accordion-body">
                        <textarea class="form-control mb-2" rows="3" placeholder="نقاط قوت" id="strength_p"></textarea>
                        <textarea class="form-control" rows="3" placeholder="نقاط ضعف" id="weakness_p"></textarea>
                    </div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#axisT">محور ت</button></h2>
                    <div id="axisT" class="accordion-collapse collapse"><div class="accordion-body">
                        <textarea class="form-control mb-2" rows="3" placeholder="نقاط قوت" id="strength_t"></textarea>
                        <textarea class="form-control" rows="3" placeholder="نقاط ضعف" id="weakness_t"></textarea>
                    </div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#axisTh">محور ث</button></h2>
                    <div id="axisTh" class="accordion-collapse collapse"><div class="accordion-body">
                        <textarea class="form-control mb-2" rows="3" placeholder="نقاط قوت" id="strength_th"></textarea>
                        <textarea class="form-control" rows="3" placeholder="نقاط ضعف" id="weakness_th"></textarea>
                    </div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#axisJ">محور ج</button></h2>
                    <div id="axisJ" class="accordion-collapse collapse"><div class="accordion-body">
                        <textarea class="form-control mb-2" rows="3" placeholder="نقاط قوت" id="strength_j"></textarea>
                        <textarea class="form-control" rows="3" placeholder="نقاط ضعف" id="weakness_j"></textarea>
                    </div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#axisCh">محور چ</button></h2>
                    <div id="axisCh" class="accordion-collapse collapse"><div class="accordion-body">
                        <textarea class="form-control mb-2" rows="3" placeholder="نقاط قوت" id="strength_ch"></textarea>
                        <textarea class="form-control" rows="3" placeholder="نقاط ضعف" id="weakness_ch"></textarea>
                    </div></div>
                </div>
            </div>

            <!-- امضاها -->
            <h5 class="text-primary mb-3"><i class="fas fa-signature me-2"></i> امضاها</h5>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label>امضای آموزگار</label>
                    <canvas id="sig_teacher" class="signature-pad" width="300" height="150"></canvas>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="sigTeacher.clear()">پاک کردن</button>
                </div>
                <div class="col-md-4">
                    <label>امضای بازدیدکننده</label>
                    <canvas id="sig_visitor" class="signature-pad" width="300" height="150"></canvas>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="sigVisitor.clear()">پاک کردن</button>
                </div>
                <div class="col-md-4">
                    <label>امضا و مهر مدیر</label>
                    <canvas id="sig_manager" class="signature-pad" width="300" height="150"></canvas>
                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="sigManager.clear()">پاک کردن</button>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-4"><input type="text" class="form-control" placeholder="نام و نام خانوادگی کارشناس گروه‌های آموزشی" id="expert_name"></div>
            </div>

            <!-- جدول بازدیدهای ثبت‌شده -->
            <div class="mt-5 no-print">
                <h5 class="text-primary mb-3"><i class="fas fa-list-ul me-2"></i> بازدیدهای ثبت‌شده</h5>
                <table class="table table-striped table-bordered" id="recordsTable">
                    <thead class="table-primary">
                        <tr><th>نام آموزگار</th><th>کد پرسنلی</th><th>پایه</th><th>معدل</th><th>تاریخ و ساعت ثبت</th><th>عملیات</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- جدول تحلیل هوشمند (جدید) -->
            <div class="mt-5 no-print">
                <h5 class="text-primary mb-3"><i class="fas fa-brain me-2"></i> تحلیل هوشمند داده‌ها</h5>
                <table class="table table-striped table-bordered" id="analysisTable">
                    <thead class="table-info">
                        <tr><th>نوع تحلیل</th><th>نتیجه</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- دکمه‌ها -->
            <div class="text-center no-print mt-4">
                <button class="btn btn-success me-2" onclick="saveForm()"><i class="fas fa-save me-2"></i>ذخیره نهایی</button>
                <button class="btn btn-primary me-2" onclick="window.print()"><i class="fas fa-print me-2"></i>چاپ PDF تمیز</button>
                <button class="btn btn-warning me-2" onclick="exportJSON()"><i class="fas fa-download me-2"></i>خروجی JSON</button>
                <button class="btn btn-info" onclick="importJSON()"><i class="fas fa-upload me-2"></i>ورودی JSON</button>
            </div>
        </div>
    </div>
</div>
<footer class="text-center mt-5 no-print">سازنده: حسین هادی پور 🔨</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let scores = {a1:0,a2:0,a3:0,b1:0,b2:0,b3:0,p1:0,p2:0,t1:0,t2:0,t3:0,th1:0,th2:0,th3:0,th4:0,th5:0,j1:0,ch1:0,ch2:0};
    let radarChart, sigTeacher, sigVisitor, sigManager;

    // نمودار عنکبوتی
    const ctx = document.getElementById('radarChart').getContext('2d');
    radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['الف: مقدماتی', 'ب: خودارتقایی', 'پ: مدیریت', 'ت: تجهیزات', 'ث: صلاحیت', 'ج: تکالیف', 'چ: ارزشیابی'],
            datasets: [{
                label: 'امتیاز کلی',
                data: [0,0,0,0,0,0,0],
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                borderColor: '#007bff',
                borderWidth: 3,
                pointBackgroundColor: '#00bfff',
                pointBorderColor: '#fff',
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            scales: { r: { min: 0, max: 3, ticks: { stepSize: 1, color: '#0056b3' } } },
            elements: { line: { tension: 0.4 } },
            plugins: { legend: { display: false } },
            animation: { duration: 1500, easing: 'easeInOutQuart' }
        }
    });

    // امضاها
    sigTeacher = new SignaturePad(document.getElementById('sig_teacher'), { penColor: 'blue' });
    sigVisitor = new SignaturePad(document.getElementById('sig_visitor'), { penColor: 'blue' });
    sigManager = new SignaturePad(document.getElementById('sig_manager'), { penColor: 'blue' });

    // آپدیت امتیازها
    document.querySelectorAll('.score').forEach(input => {
        input.addEventListener('change', () => {
            scores[input.name] = parseInt(input.value);
            const axisScores = [
                (scores.a1 + scores.a2 + scores.a3) / 3,
                (scores.b1 + scores.b2 + scores.b3) / 3,
                (scores.p1 + scores.p2) / 2,
                (scores.t1 + scores.t2 + scores.t3) / 3,
                (scores.th1 + scores.th2 + scores.th3 + scores.th4 + scores.th5) / 5,
                scores.j1,
                (scores.ch1 + scores.ch2) / 2
            ];
            radarChart.data.datasets[0].data = axisScores.map(s => s || 0);
            radarChart.update();
            autoSave();
        });
    });

    // ذخیره خودکار (با جلوگیری از تکراری)
    function autoSave() {
        const personnelCode = document.getElementById('personnel_code').value.trim();
        if (!personnelCode) return; // اگر کد خالی باشه، ذخیره نکن

        const formData = {
            region: document.getElementById('region').value,
            school: document.getElementById('school').value,
            date: document.getElementById('date').value,
            time_start: document.getElementById('time_start').value,
            time_end: document.getElementById('time_end').value,
            gender: document.querySelector('input[name="gender"]:checked')?.value || '',
            type_school: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(ch => ch.nextSibling.textContent).join(', '),
            grade: document.getElementById('grade').value,
            students: document.getElementById('students').value,
            special_students: document.getElementById('special_students').value,
            teacher_name: document.getElementById('teacher_name').value,
            employment_status: document.getElementById('employment_status').value,
            personnel_code: personnelCode,
            degree: document.getElementById('degree').value,
            major: document.getElementById('major').value,
            teaching_exp: document.getElementById('teaching_exp').value,
            current_grade_exp: document.getElementById('current_grade_exp').value,
            scores: scores,
            creative_activities: document.getElementById('creative_activities').value,
            final_evaluation: document.getElementById('final_evaluation').value,
            follow_up: document.getElementById('follow_up').value,
            strength_a: document.getElementById('strength_a').value,
            weakness_a: document.getElementById('weakness_a').value,
            strength_b: document.getElementById('strength_b').value,
            weakness_b: document.getElementById('weakness_b').value,
            strength_p: document.getElementById('strength_p').value,
            weakness_p: document.getElementById('weakness_p').value,
            strength_t: document.getElementById('strength_t').value,
            weakness_t: document.getElementById('weakness_t').value,
            strength_th: document.getElementById('strength_th').value,
            weakness_th: document.getElementById('weakness_th').value,
            strength_j: document.getElementById('strength_j').value,
            weakness_j: document.getElementById('weakness_j').value,
            strength_ch: document.getElementById('strength_ch').value,
            weakness_ch: document.getElementById('weakness_ch').value,
            sig_teacher: sigTeacher.toDataURL(),
            sig_visitor: sigVisitor.toDataURL(),
            sig_manager: sigManager.toDataURL(),
            expert_name: document.getElementById('expert_name').value,
            timestamp: new Date().toLocaleString('fa-IR')
        };
        localStorage.setItem('bazdidForm_' + personnelCode, JSON.stringify(formData)); // ذخیره/آپدیت بر اساس کد
        loadRecords();
    }

    // ذخیره نهایی با Swal
    function saveForm() {
        autoSave();
        Swal.fire({
            title: 'ذخیره شد!',
            text: 'فرم با موفقیت ذخیره شد ✅',
            icon: 'success',
            timer: 2500,
            showConfirmButton: false
        });
    }

    // بارگذاری جدول
    function loadRecords() {
        const tbody = document.querySelector('#recordsTable tbody');
        tbody.innerHTML = '';
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('bazdidForm_')) {
                const data = JSON.parse(localStorage.getItem(key));
                const totalScore = Object.values(data.scores).reduce((a, b) => a + (b || 0), 0);
                const count = Object.keys(data.scores).length;
                const avg = (totalScore / count).toFixed(2);
                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="saved-row">
                        <td>${data.teacher_name}</td>
                        <td>${data.personnel_code}</td>
                        <td>${data.grade}</td>
                        <td>${avg}</td>
                        <td>${data.timestamp}</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1" onclick="loadForm('${data.personnel_code}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord('${key}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            }
        }
        loadAnalysis(); // آپدیت تحلیل هوشمند
    }

    // جدول تحلیل هوشمند (جدید)
    function loadAnalysis() {
        const analysisBody = document.querySelector('#analysisTable tbody');
        analysisBody.innerHTML = '';

        let allAvgs = [];
        let axisTotals = {a:0, b:0, p:0, t:0, th:0, j:0, ch:0};
        let count = 0;

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('bazdidForm_')) {
                const data = JSON.parse(localStorage.getItem(key));
                const scores = data.scores;
                const axisScores = {
                    a: (scores.a1 + scores.a2 + scores.a3) / 3,
                    b: (scores.b1 + scores.b2 + scores.b3) / 3,
                    p: (scores.p1 + scores.p2) / 2,
                    t: (scores.t1 + scores.t2 + scores.t3) / 3,
                    th: (scores.th1 + scores.th2 + scores.th3 + scores.th4 + scores.th5) / 5,
                    j: scores.j1,
                    ch: (scores.ch1 + scores.ch2) / 2
                };
                const avg = Object.values(axisScores).reduce((a, b) => a + b, 0) / 7;
                allAvgs.push(avg);
                Object.keys(axisTotals).forEach(k => axisTotals[k] += axisScores[k]);
                count++;
            }
        }

        if (count === 0) {
            analysisBody.innerHTML = '<tr><td colspan="2">داده‌ای برای تحلیل وجود ندارد</td></tr>';
            return;
        }

        const overallAvg = allAvgs.reduce((a, b) => a + b, 0) / count;
        const maxAxis = Object.keys(axisTotals).reduce((max, k) => axisTotals[k] > axisTotals[max] ? k : max, 'a');
        const minAxis = Object.keys(axisTotals).reduce((min, k) => axisTotals[k] < axisTotals[min] ? k : min, 'a');
        const trend = allAvgs[allAvgs.length - 1] > allAvgs[0] ? 'بهبود' : 'کاهش';
        const suggestion = overallAvg < 2 ? 'نیاز به بهبود کلی' : 'عملکرد خوب، ادامه دهید';

        const analyses = [
            {type: 'میانگین کل امتیازها', result: overallAvg.toFixed(2)},
            {type: 'قوی‌ترین محور', result: maxAxis.toUpperCase() + ' (' + (axisTotals[maxAxis]/count).toFixed(2) + ')'},
            {type: 'ضعیف‌ترین محور', result: minAxis.toUpperCase() + ' (' + (axisTotals[minAxis]/count).toFixed(2) + ')'},
            {type: 'تحلیل روند امتیازها', result: `روند: ${trend} (از ${allAvgs[0].toFixed(2)} به ${allAvgs[allAvgs.length-1].toFixed(2)})`},
            {type: 'پیشنهاد بهبود', result: suggestion}
        ];

        analyses.forEach(anal => {
            analysisBody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${anal.type}</td>
                    <td>${anal.result}</td>
                </tr>
            `);
        });
    }

    // حذف رکورد
    function deleteRecord(key) {
        localStorage.removeItem(key);
        loadRecords();
    }

    // خروجی JSON
    function exportJSON() {
        const allData = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('bazdidForm_')) allData.push(JSON.parse(localStorage.getItem(key)));
        }
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'bazdid_forms.json';
        a.click();
    }

    // ورودی JSON
    function importJSON() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const reader = new FileReader();
            reader.readAsText(e.target.files[0]);
            reader.onload = () => {
                const data = JSON.parse(reader.result);
                data.forEach(item => {
                    const code = item.personnel_code;
                    if (code) localStorage.setItem('bazdidForm_' + code, JSON.stringify(item));
                });
                loadRecords();
                Swal.fire('موفق!', 'داده‌ها وارد شد', 'success');
            };
        };
        input.click();
    }

    // بارگذاری فرم برای ویرایش
    function loadForm(code) {
        const data = JSON.parse(localStorage.getItem('bazdidForm_' + code));
        if (!data) return;

        document.getElementById('region').value = data.region;
        document.getElementById('school').value = data.school;
        document.getElementById('date').value = data.date;
        updateJalaliDate(); // آپدیت شمسی
        document.getElementById('time_start').value = data.time_start;
        document.getElementById('time_end').value = data.time_end;
        const genderRadio = document.querySelector(`input[name="gender"][value="${data.gender}"]`);
        if (genderRadio) genderRadio.checked = true;
        const types = data.type_school.split(', ');
        document.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.checked = types.includes(ch.nextSibling.textContent.trim()));
        document.getElementById('grade').value = data.grade;
        document.getElementById('students').value = data.students;
        document.getElementById('special_students').value = data.special_students;
        document.getElementById('teacher_name').value = data.teacher_name;
        document.getElementById('employment_status').value = data.employment_status;
        document.getElementById('personnel_code').value = data.personnel_code;
        document.getElementById('degree').value = data.degree;
        document.getElementById('major').value = data.major;
        document.getElementById('teaching_exp').value = data.teaching_exp;
        document.getElementById('current_grade_exp').value = data.current_grade_exp;
        scores = data.scores;
        Object.keys(scores).forEach(key => {
            const val = scores[key];
            if (val) document.querySelector(`input[name="${key}"][value="${val}"]`).checked = true;
        });
        document.getElementById('creative_activities').value = data.creative_activities;
        document.getElementById('final_evaluation').value = data.final_evaluation;
        document.getElementById('follow_up').value = data.follow_up;
        document.getElementById('strength_a').value = data.strength_a;
        document.getElementById('weakness_a').value = data.weakness_a;
        document.getElementById('strength_b').value = data.strength_b;
        document.getElementById('weakness_b').value = data.weakness_b;
        document.getElementById('strength_p').value = data.strength_p;
        document.getElementById('weakness_p').value = data.weakness_p;
        document.getElementById('strength_t').value = data.strength_t;
        document.getElementById('weakness_t').value = data.weakness_t;
        document.getElementById('strength_th').value = data.strength_th;
        document.getElementById('weakness_th').value = data.weakness_th;
        document.getElementById('strength_j').value = data.strength_j;
        document.getElementById('weakness_j').value = data.weakness_j;
        document.getElementById('strength_ch').value = data.strength_ch;
        document.getElementById('weakness_ch').value = data.weakness_ch;
        sigTeacher.fromDataURL(data.sig_teacher);
        sigVisitor.fromDataURL(data.sig_visitor);
        sigManager.fromDataURL(data.sig_manager);
        document.getElementById('expert_name').value = data.expert_name;

        // آپدیت نمودار
        const axisScores = [
            (scores.a1 + scores.a2 + scores.a3) / 3,
            (scores.b1 + scores.b2 + scores.b3) / 3,
            (scores.p1 + scores.p2) / 2,
            (scores.t1 + scores.t2 + scores.t3) / 3,
            (scores.th1 + scores.th2 + scores.th3 + scores.th4 + scores.th5) / 5,
            scores.j1,
            (scores.ch1 + scores.ch2) / 2
        ];
        radarChart.data.datasets[0].data = axisScores.map(s => s || 0);
        radarChart.update();
    }

    // تابع تبدیل تاریخ میلادی به شمسی
    function gregorianToJalali(gy, gm, gd) {
        let g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        let jy = (gy > 1600) ? 979 : 0;
        gy -= (gy > 1600) ? 1600 : 621;
        let gy2 = (gm > 2) ? gy + 1 : gy;
        let days = (365 * gy) + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400) - 80 + gd + g_d_m[gm - 1];
        jy += 33 * Math.floor(days / 12053);
        days %= 12053;
        jy += 4 * Math.floor(days / 1461);
        days %= 1461;
        if (days > 365) {
            jy += Math.floor((days - 1) / 365);
            days = (days - 1) % 365;
        }
        let jm, jd;
        if (days < 186) {
            jm = 1 + Math.floor(days / 31);
            jd = 1 + (days % 31);
        } else {
            days -= 186;
            jm = 7 + Math.floor(days / 30);
            jd = 1 + (days % 30);
        }
        return [jy, jm, jd].join('/');
    }

    // آپدیت تاریخ شمسی
    function updateJalaliDate() {
        const dateInput = document.getElementById('date').value;
        if (dateInput) {
            const [gy, gm, gd] = dateInput.split('-').map(Number);
            const jalali = gregorianToJalali(gy, gm, gd);
            document.getElementById('jalali_date').textContent = `شمسی: ${jalali}`;
        } else {
            document.getElementById('jalali_date').textContent = '';
        }
    }

    // شروع
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    updateJalaliDate();
    loadRecords();

    // اضافه کردن listenerها برای ذخیره با هر تغییر
    const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="time"], textarea, input[type="radio"], input[type="checkbox"]');
    inputs.forEach(el => {
        el.addEventListener(el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'number' ? 'input' : 'change', autoSave);
    });
    document.getElementById('date').addEventListener('change', updateJalaliDate);
    sigTeacher.onEnd = autoSave;
    sigVisitor.onEnd = autoSave;
    sigManager.onEnd = autoSave;
</script>
</body>
</html>
